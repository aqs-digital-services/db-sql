name: Deploy Database with Liquibase to Azure

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ðŸ“¥ Checkout do repositÃ³rio
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ðŸ”§ Instalando Liquibase corretamente
    - name: Instalar Liquibase
      run: |
        LIQUIBASE_VERSION="4.23.0"
        wget -q "https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.tar.gz" -O liquibase.tar.gz
        tar -xzf liquibase.tar.gz
        sudo mv liquibase /usr/local/bin/liquibase
        chmod +x /usr/local/bin/liquibase
        liquibase --version

    # ðŸš€ Login na Azure (Corrigido com subscription-id e auth-type)
    - name: Login Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        auth-type: SERVICE_PRINCIPAL

    # ðŸ”„ Aplicar mudanÃ§as no banco de dados com Liquibase
    - name: Executar migraÃ§Ãµes Liquibase no Azure SQL
      run: |
        liquibase --changeLogFile=database/changelog.xml \
                  --url="jdbc:postgresql://${{ secrets.AZURE_SQL_SERVER }}:5432/${{ secrets.AZURE_DATABASE }}" \
                  --username="${{ secrets.AZURE_SQL_USER }}" \
                  --password="${{ secrets.AZURE_SQL_PASSWORD }}" \
                  update
