name: Deploy SQL Scripts to Azure

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ✅ Checkout do repositório
    - name: Checkout Repository
      uses: actions/checkout@v3

    # ✅ Exibir logs iniciais para rastreabilidade
    - name: Exibir informações do ambiente
      run: |
        echo "Iniciando deploy do banco de dados..."
        echo "Data e hora: $(date)"
        echo "Runner: $RUNNER_OS"

    # ✅ Login no Azure (corrigido: client-id, tenant-id e secret)
    - name: Login no Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # ✅ Adicionar IP do GitHub Actions ao firewall do Azure (corrigido)
    - name: Adicionar IP ao Firewall do Azure
      run: |
        RUNNER_IP=$(curl -s https://api64.ipify.org)
        az sql server firewall-rule create \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --server ${{ secrets.AZURE_SQL_SERVER }} \
          --name GitHubRunnerIP \
          --start-ip-address $RUNNER_IP \
          --end-ip-address $RUNNER_IP

    # ✅ Executar Liquibase usando a ação oficial
    - name: Executar Liquibase
      uses: liquibase/liquibase-github-action@v4
      with:
        operation: 'update'
        changeLogFile: 'database/changelog.xml'
        url: ${{ secrets.AZURE_DATABASE_URL }}
        username: ${{ secrets.AZURE_SQL_USER }}
        password: ${{ secrets.AZURE_SQL_PASSWORD }}
        classpath: './database'
        logLevel: 'info'

    # ✅ Rollback automático em caso de falha (corrigido: `count` ao invés de `rollbackCount`)
    - name: Rollback em caso de erro
      if: failure()
      uses: liquibase/liquibase-github-action@v4
      with:
        operation: 'rollback'
        changeLogFile: 'database/changelog.xml'
        url: ${{ secrets.AZURE_DATABASE_URL }}
        username: ${{ secrets.AZURE_SQL_USER }}
        password: ${{ secrets.AZURE_SQL_PASSWORD }}
        classpath: './database'
        count: '1'  # Corrigido: rollback correto
        logLevel: 'info'

    # ✅ Remover IP do GitHub Actions do Firewall após execução (corrigido)
    - name: Remover IP do Firewall do Azure
      if: always()
      run: |
        RUNNER_IP=$(curl -s https://api64.ipify.org)
        az sql server firewall-rule delete \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --server ${{ secrets.AZURE_SQL_SERVER }} \
          --name GitHubRunnerIP || echo "Regra de firewall já removida ou não encontrada."
