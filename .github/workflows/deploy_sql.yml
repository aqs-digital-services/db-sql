name: Deploy Database with Liquibase to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'database/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 📥 Checkout do repositório
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 🔧 Adicionando repositório Microsoft (caso seja SQL Server, senão remova esta parte)
    - name: Adicionar repositório Microsoft
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update

    # 🔧 Instalando o Liquibase
    - name: Instalar Liquibase
      run: |
        LIQUIBASE_VERSION="4.23.0"
        curl -L "https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.tar.gz" -o liquibase.tar.gz
        tar -xzf liquibase.tar.gz
        sudo mv liquibase /opt/liquibase
        sudo ln -s /opt/liquibase/liquibase /usr/local/bin/liquibase

    # 🚀 Login na Azure
    - name: Login Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

    # 🔄 Aplicar mudanças no banco de dados com Liquibase
    - name: Executar migrações Liquibase no Azure SQL
      run: |
        liquibase --changeLogFile=database/changelog.xml \
                  --url="jdbc:postgresql://${{ secrets.AZURE_SQL_SERVER }}:5432/${{ secrets.AZURE_DATABASE }}" \
                  --username="${{ secrets.AZURE_SQL_USER }}" \
                  --password="${{ secrets.AZURE_SQL_PASSWORD }}" \
                  update
